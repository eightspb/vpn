<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VPN Dashboard</title>
<style>
:root {
  --bg:      #0d1117;
  --s1:      #161b22;
  --s2:      #1c2128;
  --s3:      #21262d;
  --border:  #30363d;
  --text:    #e6edf3;
  --dim:     #8b949e;
  --green:   #3fb950;
  --yellow:  #d29922;
  --red:     #f85149;
  --blue:    #58a6ff;
  --cyan:    #39d0d8;
  --purple:  #bc8cff;
  --glow-g:  rgba(63,185,80,0.15);
  --glow-r:  rgba(248,81,73,0.15);
  --ring-bg: #21262d;
  --ring-txt: #e6edf3;
}
html.light {
  --bg:      #f6f8fa;
  --s1:      #ffffff;
  --s2:      #f0f3f6;
  --s3:      #e1e4e8;
  --border:  #d0d7de;
  --text:    #1f2328;
  --dim:     #656d76;
  --green:   #1a7f37;
  --yellow:  #9a6700;
  --red:     #cf222e;
  --blue:    #0969da;
  --cyan:    #0e7c86;
  --purple:  #8250df;
  --glow-g:  rgba(26,127,55,0.12);
  --glow-r:  rgba(207,34,46,0.12);
  --ring-bg: #e1e4e8;
  --ring-txt: #1f2328;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  font-size: 12px;
  display: flex;
  flex-direction: column;
  height: 100vh;
  transition: background .3s, color .3s;
}

/* ======= HEADER ======= */
#hdr {
  flex-shrink: 0;
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  padding: 6px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background .3s;
}
#hdr-title {
  font-size: 13px; font-weight: 700; letter-spacing: .04em;
  color: var(--blue); white-space: nowrap;
}
#hdr-ts  { color: var(--dim); font-size: 11px; white-space: nowrap; }
.hdr-sep { width: 1px; height: 14px; background: var(--border); flex-shrink: 0; }
.hdr-pill {
  display: flex; align-items: center; gap: 5px;
  padding: 2px 9px; border-radius: 20px; border: 1px solid var(--border);
  font-size: 11px; font-weight: 600;
}
.hdr-pill.on  { border-color: rgba(63,185,80,.35);  background: var(--glow-g); color: var(--green); }
.hdr-pill.off { border-color: rgba(248,81,73,.35); background: var(--glow-r); color: var(--red); }
.dot { width:7px; height:7px; border-radius:50%; }
.dot.on  { background: var(--green); animation: pulse 2s infinite; }
.dot.off { background: var(--red); }
@keyframes pulse {
  0%,100%{ box-shadow: 0 0 0 0 rgba(63,185,80,.5); }
  60%    { box-shadow: 0 0 0 5px rgba(63,185,80,0); }
}
#hdr-right { margin-left: auto; display:flex; align-items:center; gap:10px; }
.cd-wrap { display:flex; align-items:center; gap:5px; color:var(--dim); font-size:11px; }
.cd-bar  { width:50px; height:2px; background:var(--border); border-radius:1px; overflow:hidden; }
.cd-fill { height:100%; background:var(--blue); border-radius:1px; transition:width .15s linear; }
#cd-num  { min-width:16px; text-align:right; color:var(--text); }
#hdr-traffic {
  color:var(--dim); font-size:11px; font-family:monospace; white-space:nowrap;
}
.theme-btn {
  padding: 2px 8px; border-radius: 20px; border: 1px solid var(--border);
  background: transparent; color: var(--dim); font-size: 11px; cursor: pointer;
  font-family: inherit; transition: .15s; white-space: nowrap;
}
.theme-btn:hover { border-color: var(--blue); color: var(--blue); }

/* ======= LAYOUT ======= */
#layout {
  flex: 1;
  display: grid;
  grid-template-rows: auto 1fr;
  grid-template-columns: 1fr 1fr;
  grid-template-areas:
    "v1      v2"
    "bottom  bottom";
  gap: 0;
  overflow: hidden;
  border-top: 1px solid var(--border);
}

/* ======= SERVER CARDS ======= */
.srv {
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
}
.srv:last-of-type { border-right: none; }
#pv1 { grid-area: v1; }
#pv2 { grid-area: v2; }

.srv-hdr {
  background: var(--s2);
  border-bottom: 1px solid var(--border);
  padding: 5px 12px;
  display: flex; align-items: center; gap: 8px;
}
.srv-name { font-weight:700; font-size:13px; }
.srv-ip   { font-family:monospace; font-size:11px; color:var(--blue); }
.srv-host { color:var(--dim); font-size:10px; margin-left:auto; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px; }
.srv-err  { color:var(--red); font-size:11px; font-family:monospace; padding:8px 12px; }

.srv-body { flex:1; overflow:hidden; display:flex; flex-direction:column; }
.srv-main { flex:1; overflow:hidden; display:flex; flex-direction:column; }

/* ---- Gauges row: 4 ring gauges ---- */
.gauges-row {
  display: flex;
  align-items: center;
  justify-content: space-around;
  padding: 8px 6px 4px;
  gap: 2px;
  flex-shrink: 0;
}
.gauge {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1px;
  min-width: 64px;
}
.gauge-svg { width: 54px; height: 54px; }
.gauge-svg circle { transition: stroke-dasharray .4s ease, stroke .4s ease; }
.gauge-label { font-size: 9px; color: var(--dim); text-align: center; line-height: 1.2; }
.gauge-sub { font-size: 9px; color: var(--dim); text-align: center; font-family: monospace; line-height: 1.3; }

/* ---- Details grid ---- */
.details-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
  padding: 2px 8px 4px;
  flex-shrink: 0;
}
.detail-item {
  display: flex; align-items: center; gap: 3px;
  padding: 1px 4px;
  font-size: 10px;
}
.detail-key { color: var(--dim); font-size: 9px; white-space: nowrap; }
.detail-val { color: var(--text); font-family: monospace; font-weight: 600; font-size: 10px; }

/* ---- Network section ---- */
.net-section {
  border-top: 1px solid var(--border);
  padding: 4px 10px;
  display: flex;
  flex-direction: column;
  gap: 2px;
  flex-shrink: 0;
}
.net-speeds {
  display: flex; align-items: center; gap: 10px;
}
.net-if { color: var(--dim); font-size: 10px; font-family: monospace; }
.net-speed { display:flex; align-items:center; gap:3px; font-family:monospace; font-size:11px; font-weight:600; }
.net-speed .arr { font-size:13px; }
.arr-d { color:var(--green); }
.arr-u { color:var(--blue); }
.net-totals {
  display: flex; align-items: center; gap: 10px;
  font-size: 10px;
}
.net-total-item { display: flex; align-items: center; gap: 3px; }
.net-total-lbl { color: var(--dim); font-size: 9px; }
.net-total-val { font-family: monospace; font-weight: 600; font-size: 10px; }

.spark-wrap { width: 100%; height: 44px; overflow: hidden; border-radius: 4px; background: var(--s2); }
.spark-wrap svg { width:100%; height:100%; display:block; }

/* ---- Top connections ---- */
.top-conn-row {
  padding: 2px 10px; display:flex; align-items:baseline; gap:4px;
  overflow:hidden; flex-shrink: 0;
}
.top-conn-lbl { color:var(--dim); font-size:9px; flex-shrink:0; }
.top-conn-val { color:var(--cyan); font-size:10px; font-family:monospace; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* ---- Status row ---- */
.status-row {
  background: var(--s2);
  border-top: 1px solid var(--border);
  padding: 4px 10px;
  display: flex; flex-wrap: wrap; gap: 5px; align-items: center;
  flex-shrink: 0;
}
.chip {
  display:inline-flex; align-items:center; gap:3px;
  padding: 1px 7px; border-radius:10px;
  font-size:10px; font-weight:600; border:1px solid transparent;
  white-space:nowrap;
}
.chip.g { background:rgba(63,185,80,.12);  border-color:rgba(63,185,80,.3);  color:var(--green); }
.chip.y { background:rgba(210,153,34,.12); border-color:rgba(210,153,34,.3); color:var(--yellow); }
.chip.r { background:rgba(248,81,73,.12);  border-color:rgba(248,81,73,.3);  color:var(--red); }
.chip.d { background:var(--s3); border-color:var(--border); color:var(--dim); }
.chip-dot { width:5px; height:5px; border-radius:50%; background:currentColor; }
.chip-sep { width:1px; height:12px; background:var(--border); margin:0 2px; }

/* ======= BOTTOM TABS ======= */
#bottom-area {
  grid-area: bottom;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-top: 1px solid var(--border);
}
.tab-bar {
  flex-shrink: 0;
  background: var(--s2);
  border-bottom: 1px solid var(--border);
  padding: 0 12px;
  display: flex; align-items: stretch; gap: 0;
}
.tab-btn {
  padding: 5px 14px; font-size: 11px; font-weight: 600;
  color: var(--dim); background: transparent; border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer; transition: .15s; font-family: inherit;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
.tab-btn .tab-badge {
  display: inline-block; padding: 0 5px; border-radius: 8px;
  background: var(--s3); border: 1px solid var(--border);
  font-size: 9px; margin-left: 4px; color: var(--text); font-weight: 700;
}
.tab-content { flex: 1; overflow: hidden; position: relative; }
.tab-pane { position: absolute; inset: 0; overflow-y: auto; display: none; padding: 4px 0; }
.tab-pane.active { display: block; }

/* ---- Log ---- */
.log-line {
  display: flex; align-items: baseline; gap: 6px;
  padding: 1px 12px; line-height: 1.6;
  font-family: 'Consolas','Cascadia Code',monospace;
  font-size: 10.5px; white-space: pre-wrap; word-break: break-all;
  border-left: 2px solid transparent;
}
.log-line:hover { background: var(--s2); }
.log-line.INFO  { border-color: var(--blue); }
.log-line.WARN  { border-color: var(--yellow); background: rgba(210,153,34,.04); }
.log-line.ERROR { border-color: var(--red);    background: rgba(248,81,73,.06); }
.log-line.DEBUG { border-color: transparent; }
.log-ts   { color:var(--dim); flex-shrink:0; font-size:10px; }
.log-lvl  { flex-shrink:0; width:30px; font-size:9px; font-weight:700; letter-spacing:.04em; text-transform:uppercase; }
.log-lvl.INFO  { color:var(--blue); }
.log-lvl.WARN  { color:var(--yellow); }
.log-lvl.ERROR { color:var(--red); }
.log-lvl.DEBUG { color:var(--dim); }
.log-msg  { color:var(--text); overflow:hidden; text-overflow:ellipsis; }
.log-filter-btn {
  padding:1px 7px; border-radius:10px; font-size:10px; font-weight:600; cursor:pointer;
  border:1px solid var(--border); background:transparent; color:var(--dim); transition:.15s;
}
.log-filter-btn.active { color:var(--text); border-color:var(--blue); background:rgba(88,166,255,.1); }
#log-autoscroll {
  padding:1px 7px; border-radius:10px; font-size:10px; cursor:pointer;
  border:1px solid var(--border); background:transparent; color:var(--dim); transition:.15s;
  margin-left:auto;
}
#log-autoscroll.on { color:var(--green); border-color:rgba(63,185,80,.4); background:rgba(63,185,80,.08); }
.log-toolbar {
  flex-shrink: 0; display: flex; align-items: center; gap: 6px;
  padding: 4px 12px; border-bottom: 1px solid var(--border); background: var(--s1);
}

/* ---- Connections ---- */
.conn-section { margin-bottom:4px; }
.conn-section-hdr {
  padding: 2px 12px;
  font-size:10px; font-weight:700; letter-spacing:.05em; text-transform:uppercase;
  color:var(--dim); display:flex; gap:8px; align-items:center;
}
.conn-count { padding:0 5px; border-radius:8px; background:var(--s3); border:1px solid var(--border); color:var(--text); }
.conn-row {
  display: flex; align-items: center; gap: 6px;
  padding: 2px 12px;
  font-family: monospace; font-size: 10.5px;
  border-left: 2px solid transparent;
}
.conn-row:hover { background:var(--s2); border-left-color:var(--border); }
.conn-local  { color:var(--dim); min-width:120px; overflow:hidden; text-overflow:ellipsis; }
.conn-arrow  { color:var(--border); flex-shrink:0; }
.conn-remote { color:var(--text); overflow:hidden; text-overflow:ellipsis; }
.conn-none   { padding:4px 12px; color:var(--dim); font-size:11px; font-style:italic; }

/* ---- Activity ---- */
.act-line {
  display: flex; align-items: baseline; gap: 5px;
  padding: 1px 12px; line-height: 1.6;
  font-family: 'Consolas','Cascadia Code',monospace;
  font-size: 10.5px; white-space: pre-wrap; word-break: break-all;
  border-left: 2px solid transparent;
}
.act-line:hover { background: var(--s2); }
.act-line.filter  { border-color: var(--purple); }
.act-line.conn    { border-color: var(--cyan); }
.act-line.warn    { border-color: var(--yellow); }
.act-line.error   { border-color: var(--red); }
.act-ts   { color:var(--dim); flex-shrink:0; font-size:10px; }
.act-tag  { flex-shrink:0; min-width:42px; font-size:9px; font-weight:700; letter-spacing:.04em; text-transform:uppercase; }
.act-tag.filter { color:var(--purple); }
.act-tag.conn   { color:var(--cyan); }
.act-tag.warn   { color:var(--yellow); }
.act-tag.error  { color:var(--red); }
.act-msg  { color:var(--text); overflow:hidden; text-overflow:ellipsis; }
.act-none { padding:6px 12px; color:var(--dim); font-size:11px; font-style:italic; }
#act-clear {
  padding:1px 7px; border-radius:10px; font-size:10px; cursor:pointer;
  border:1px solid var(--border); background:transparent; color:var(--dim); transition:.15s;
  margin-left:auto;
}
#act-clear:hover { border-color:var(--red); color:var(--red); }

/* scrollbar */
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:var(--dim); }

/* offline overlay */
.offline-overlay {
  position:absolute; inset:0; background:rgba(13,17,23,.7);
  display:flex; align-items:center; justify-content:center;
  font-size:13px; color:var(--red); font-weight:600; letter-spacing:.04em;
  pointer-events:none;
}

/* ======= PING MODAL ======= */
#ping-btn {
  padding: 2px 10px; border-radius: 20px;
  border: 1px solid var(--border); background: transparent;
  color: var(--dim); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: .15s; white-space: nowrap; font-family: inherit;
}
#ping-btn:hover { border-color: var(--blue); color: var(--blue); background: rgba(88,166,255,.06); }
#ping-btn.running { border-color: rgba(63,185,80,.4); color: var(--green); background: rgba(63,185,80,.06); animation: pulse 1s infinite; }
.ping-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(13,17,23,.65); z-index: 200;
  align-items: flex-start; justify-content: center; padding-top: 46px;
}
.ping-overlay.open { display: flex; }
.ping-box {
  background: var(--s1); border: 1px solid var(--border);
  border-radius: 10px; width: 420px; max-width: 95vw;
  box-shadow: 0 8px 32px rgba(0,0,0,.5); overflow: hidden;
}
.ping-hdr {
  background: var(--s2); border-bottom: 1px solid var(--border);
  padding: 7px 14px; display: flex; align-items: center; gap: 8px;
}
.ping-title { font-weight: 700; font-size: 13px; flex: 1; }
.ping-close {
  background: none; border: none; color: var(--dim); cursor: pointer;
  font-size: 15px; padding: 0 2px; transition: .15s; line-height: 1; font-family: inherit;
}
.ping-close:hover { color: var(--text); }
.ping-rows { padding: 6px 0; }
.ping-row {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 14px; font-size: 11px;
}
.ping-row:hover { background: var(--s2); }
.ping-label { font-weight: 700; min-width: 54px; color: var(--text); font-family: monospace; }
.ping-host  { flex: 1; color: var(--dim); font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.ping-badge {
  padding: 1px 8px; border-radius: 8px; font-size: 10px; font-weight: 700;
  border: 1px solid transparent; white-space: nowrap;
}
.ping-badge.ok   { background: rgba(63,185,80,.12);  border-color: rgba(63,185,80,.3);  color: var(--green); }
.ping-badge.fail { background: rgba(248,81,73,.12);  border-color: rgba(248,81,73,.3);  color: var(--red); }
.ping-badge.wait { background: var(--s3); border-color: var(--border); color: var(--dim); }
.ping-footer {
  border-top: 1px solid var(--border); padding: 6px 14px;
  display: flex; justify-content: space-between; align-items: center;
  font-size: 10px; color: var(--dim);
}
#ping-rerun {
  padding: 2px 9px; border-radius: 10px; border: 1px solid var(--border);
  background: transparent; color: var(--dim); font-size: 10px; cursor: pointer;
  font-family: inherit; transition: .15s;
}
#ping-rerun:hover:not(:disabled) { border-color: var(--blue); color: var(--blue); }
#ping-rerun:disabled { opacity: .5; cursor: default; }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div id="hdr">
  <span id="hdr-title">&#x2B21; VPN</span>
  <div class="hdr-sep"></div>
  <div class="hdr-pill off" id="pill-v1"><div class="dot off" id="hdot-v1"></div><span id="hname-v1">VPS1</span></div>
  <div class="hdr-pill off" id="pill-v2"><div class="dot off" id="hdot-v2"></div><span id="hname-v2">VPS2</span></div>
  <div class="hdr-pill off" id="pill-vpn"><div class="dot off" id="hdot-vpn"></div><span id="hcount-vpn">Active VPN: 0</span></div>
  <div class="hdr-sep"></div>
  <span id="hdr-traffic">Traffic: —</span>
  <div id="hdr-right">
    <button class="theme-btn" id="theme-btn" title="Переключить тему">☀ Light</button>
    <button id="ping-btn" onclick="openPingModal()">◎ Ping</button>
    <span id="hdr-ts">—</span>
    <div class="cd-wrap">
      <span id="cd-num">5s</span>
      <div class="cd-bar"><div class="cd-fill" id="cd-fill" style="width:100%"></div></div>
    </div>
  </div>
</div>

<!-- ===== MAIN LAYOUT ===== -->
<div id="layout">

  <!-- VPS1 -->
  <div class="srv" id="pv1">
    <div class="srv-hdr">
      <div class="dot off" id="dot-v1"></div>
      <span class="srv-name">VPS1</span>
      <span class="srv-ip" id="ip-v1"></span>
      <span class="srv-host" id="host-v1"></span>
    </div>
    <div class="srv-body" id="body-v1">
      <div class="srv-main">
        <div class="gauges-row" id="gauges-v1"></div>
        <div class="details-grid" id="details-v1"></div>
        <div class="net-section">
          <div class="net-speeds">
            <span class="net-if" id="if-v1">eth0</span>
            <div class="net-speed"><span class="arr arr-d">↓</span><span id="rx-v1">—</span></div>
            <div class="net-speed"><span class="arr arr-u">↑</span><span id="tx-v1">—</span></div>
            <div class="net-totals">
              <div class="net-total-item"><span class="net-total-lbl">total↓</span><span class="net-total-val" id="rxtotal-v1" style="color:var(--green)">—</span></div>
              <div class="net-total-item"><span class="net-total-lbl">total↑</span><span class="net-total-val" id="txtotal-v1" style="color:var(--blue)">—</span></div>
            </div>
          </div>
          <div class="spark-wrap" id="spark-v1"></div>
        </div>
        <div class="top-conn-row">
          <span class="top-conn-lbl">top:</span>
          <span class="top-conn-val" id="topconn-v1">—</span>
        </div>
      </div>
      <div class="status-row" id="chips-v1"></div>
    </div>
    <div class="srv-err" id="err-v1" style="display:none"></div>
  </div>

  <!-- VPS2 -->
  <div class="srv" id="pv2">
    <div class="srv-hdr">
      <div class="dot off" id="dot-v2"></div>
      <span class="srv-name">VPS2</span>
      <span class="srv-ip" id="ip-v2"></span>
      <span class="srv-host" id="host-v2"></span>
    </div>
    <div class="srv-body" id="body-v2">
      <div class="srv-main">
        <div class="gauges-row" id="gauges-v2"></div>
        <div class="details-grid" id="details-v2"></div>
        <div class="net-section">
          <div class="net-speeds">
            <span class="net-if" id="if-v2">eth0</span>
            <div class="net-speed"><span class="arr arr-d">↓</span><span id="rx-v2">—</span></div>
            <div class="net-speed"><span class="arr arr-u">↑</span><span id="tx-v2">—</span></div>
            <div class="net-totals">
              <div class="net-total-item"><span class="net-total-lbl">total↓</span><span class="net-total-val" id="rxtotal-v2" style="color:var(--green)">—</span></div>
              <div class="net-total-item"><span class="net-total-lbl">total↑</span><span class="net-total-val" id="txtotal-v2" style="color:var(--blue)">—</span></div>
            </div>
          </div>
          <div class="spark-wrap" id="spark-v2"></div>
        </div>
        <div class="top-conn-row">
          <span class="top-conn-lbl">top:</span>
          <span class="top-conn-val" id="topconn-v2">—</span>
        </div>
      </div>
      <div class="status-row" id="chips-v2"></div>
    </div>
    <div class="srv-err" id="err-v2" style="display:none"></div>
  </div>

  <!-- Bottom tabbed area -->
  <div id="bottom-area">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="log">Monitor Log <span class="tab-badge" id="log-count">0</span></button>
      <button class="tab-btn" data-tab="conn">Connections <span class="tab-badge" id="conn-badge">0</span></button>
      <button class="tab-btn" data-tab="activity">Activity <span class="tab-badge" id="act-badge">0</span></button>
    </div>
    <div class="tab-content">
      <!-- Log pane -->
      <div class="tab-pane active" id="pane-log">
        <div class="log-toolbar">
          <button class="log-filter-btn active" data-lvl="DEBUG">DBG</button>
          <button class="log-filter-btn active" data-lvl="INFO">INF</button>
          <button class="log-filter-btn active" data-lvl="WARN">WRN</button>
          <button class="log-filter-btn active" data-lvl="ERROR">ERR</button>
          <button id="log-autoscroll" class="on" title="Toggle auto-scroll">↓ auto</button>
        </div>
        <div id="log-body" style="height:calc(100% - 30px);overflow-y:auto;padding:4px 0"></div>
      </div>
      <!-- Connections pane -->
      <div class="tab-pane" id="pane-conn">
        <div id="conn-body" style="padding:6px 0"></div>
      </div>
      <!-- Activity pane -->
      <div class="tab-pane" id="pane-activity">
        <div style="padding:4px 12px;display:flex;align-items:center">
          <span style="color:var(--dim);font-size:10px">фильтры · соединения</span>
          <button id="act-clear" title="Очистить">✕ clear</button>
        </div>
        <div id="activity-body" style="height:calc(100% - 28px);overflow-y:auto;padding:4px 0"></div>
      </div>
    </div>
  </div>

</div><!-- #layout -->

<!-- ===== PING MODAL ===== -->
<div class="ping-overlay" id="ping-overlay">
  <div class="ping-box" id="ping-box">
    <div class="ping-hdr">
      <span class="ping-title">◎ Ping Check</span>
      <button class="ping-close" onclick="closePingModal()" title="Закрыть">✕</button>
    </div>
    <div class="ping-rows" id="ping-rows"></div>
    <div class="ping-footer">
      <span id="ping-status-msg"></span>
      <button id="ping-rerun" onclick="runPing()">↺ Повторить</button>
    </div>
  </div>
</div>

<script>
'use strict';

const DATA_URL   = 'vpn-output/data.json';
const POLL_MS    = 2000;
const HIST_MAX   = 60;
const LS_KEY     = 'vpn_dash4';

let lastData = null;

// ---- Theme ----
function applyTheme(t) {
  document.documentElement.classList.toggle('light', t==='light');
  el('theme-btn').textContent = t==='light' ? '☾ Dark' : '☀ Light';
  try { localStorage.setItem('vpn_theme', t); } catch(_){}
}
(function initTheme(){
  const saved = localStorage.getItem('vpn_theme');
  if(saved) applyTheme(saved);
})();
document.getElementById('theme-btn').addEventListener('click', ()=>{
  const isLight = document.documentElement.classList.contains('light');
  applyTheme(isLight ? 'dark' : 'light');
});

// ---- Tabs ----
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    el('pane-'+btn.dataset.tab).classList.add('active');
  });
});

// ---- History ----
const HKEYS = ['v1_rx','v1_tx','v2_rx','v2_tx'];
let hist = (() => {
  const d = Object.fromEntries(HKEYS.map(k=>[k,[]]));
  try {
    const r = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
    HKEYS.forEach(k=>{ if(Array.isArray(r[k])) d[k]=r[k]; });
  } catch(_){}
  return d;
})();
function pushHist(k,v){ hist[k].push(+v||0); if(hist[k].length>HIST_MAX) hist[k].shift(); }
function saveHist(){ try{localStorage.setItem(LS_KEY,JSON.stringify(hist));}catch(_){} }

// ---- Format ----
function fmtBytes(bps) {
  if (!bps || bps<=0) return '0 B/s';
  const u=['B/s','KB/s','MB/s','GB/s'];
  let i=0, v=bps;
  while(v>=1024&&i<3){v/=1024;i++;}
  if(i===0) return `${Math.round(v)} ${u[i]}`;
  return v>=100?`${Math.round(v)} ${u[i]}`:`${v.toFixed(1)} ${u[i]}`;
}
function fmtBytesTotal(bytes) {
  if (!bytes || bytes<=0) return '0 B';
  const u=['B','KB','MB','GB','TB'];
  let i=0, v=bytes;
  while(v>=1024&&i<4){v/=1024;i++;}
  if(i===0) return `${Math.round(v)} ${u[i]}`;
  return v>=100?`${Math.round(v)} ${u[i]}`:`${v.toFixed(1)} ${u[i]}`;
}
function fmtAge(s){
  if(s==null||s<0) return {t:'never',c:'r'};
  if(s<120)  return {t:`${s}s`,   c:'g'};
  if(s<600)  return {t:`${Math.round(s/60)}m`,c:'y'};
  return              {t:`${Math.round(s/60)}m`,c:'r'};
}
function fmtUptime(s){
  if(!s||s<=0) return '—';
  const d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60);
  if(d>0) return `${d}d ${h}h`;
  if(h>0) return `${h}h ${m}m`;
  return `${m}m`;
}
function fmtSwap(raw){
  if(!raw||raw==='0/0MB') return '—';
  const m=raw.match(/^(\d+)\/(\d+)MB/);
  if(!m) return raw;
  return (+m[2]===0) ? '—' : `${m[1]}/${m[2]}MB`;
}
function fmtMB(mb) {
  if(mb==null) return '—';
  if(mb>=1024) return `${(mb/1024).toFixed(1)} GB`;
  return `${Math.round(mb)} MB`;
}
function fmtNum(n) {
  if(n==null||n===0) return '0';
  if(n>=1000000) return `${(n/1000000).toFixed(1)}M`;
  if(n>=1000) return `${(n/1000).toFixed(1)}K`;
  return String(n);
}
function stCls(v){
  const s=String(v||'').toLowerCase();
  return ['active','up','ok','yes'].includes(s)?'g':['unknown','degraded'].includes(s)?'y':'r';
}
function gaugeColor(pct){
  if(pct>=85) return 'var(--red)';
  if(pct>=60) return 'var(--yellow)';
  return 'var(--green)';
}
function ringColor(load1){
  if(load1>=2)   return 'var(--red)';
  if(load1>=0.8) return 'var(--yellow)';
  return 'var(--blue)';
}

// ---- SVG Ring Gauge builder ----
function ringSvg(id, pct, color, centerText, label, sub) {
  const circ = 2*Math.PI*14;
  const dash = (Math.min(100, pct)/100)*circ;
  return `<div class="gauge">
    <svg class="gauge-svg" viewBox="0 0 36 36">
      <circle cx="18" cy="18" r="14" fill="none" stroke="var(--ring-bg)" stroke-width="3"/>
      <circle cx="18" cy="18" r="14" fill="none" stroke="${color}" stroke-width="3"
        stroke-dasharray="${dash.toFixed(1)} ${(circ-dash).toFixed(1)}" stroke-linecap="round"
        transform="rotate(-90 18 18)" id="${id}-arc"/>
      <text x="18" y="19.5" text-anchor="middle" dominant-baseline="middle"
        font-size="7" fill="var(--ring-txt)" font-family="monospace" font-weight="700">${centerText}</text>
    </svg>
    <div class="gauge-label">${label}</div>
    <div class="gauge-sub">${sub}</div>
  </div>`;
}

// ---- Sparkline ----
function spark(vals, colorDown, colorUp, valsUp){
  if(!vals||vals.length<2) return '';
  const W=400, H=44;
  const all = valsUp ? vals.concat(valsUp) : vals;
  const mx=Math.max(...all)||1;
  function poly(arr, color, opacity){
    const pts=arr.map((v,i)=>{
      const x=(i/(arr.length-1))*W;
      const y=H-2-((v||0)/mx)*(H-4);
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(' ');
    const fill = pts + ` ${W},${H} 0,${H}`;
    return `<polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round" opacity="${opacity}"/>
      <polygon points="${fill}" fill="${color}" opacity="${opacity*0.15}"/>`;
  }
  let svg = `<svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">`;
  svg += poly(vals, colorDown, 0.9);
  if(valsUp) svg += poly(valsUp, colorUp, 0.7);
  svg += '</svg>';
  return svg;
}

// ---- DOM ----
function el(id){ return document.getElementById(id); }
function setT(id,t){ const e=el(id); if(e) e.textContent=t; }
function setH(id,h){ const e=el(id); if(e) e.innerHTML=h; }
function escH(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function countActiveVpnPeers(d){
  if(!d?.online) return 0;
  const active = Number(d.active_peers_awg1);
  if(Number.isFinite(active) && active >= 0) return active;
  const hs = Number(d.hs1_age);
  const hsFresh = Number.isFinite(hs) && hs >= 0 && hs <= 180;
  return hsFresh ? (Number(d.peers_awg1) || 0) : 0;
}

function renderHdrVpnCount(data){
  const total = countActiveVpnPeers(data?.vps1);
  setT('hcount-vpn', `Active VPN: ${total}`);
  const dotEl = el('hdot-vpn'), pillEl = el('pill-vpn');
  if(dotEl) dotEl.className = 'dot ' + (total > 0 ? 'on' : 'off');
  if(pillEl) pillEl.className = 'hdr-pill ' + (total > 0 ? 'on' : 'off');
}

function renderHdrTraffic(data){
  const v1 = data?.vps1, v2 = data?.vps2;
  const rxT = (v1?.rx_total||0) + (v2?.rx_total||0);
  const txT = (v1?.tx_total||0) + (v2?.tx_total||0);
  const rxS = (v1?.rx_speed||0) + (v2?.rx_speed||0);
  const txS = (v1?.tx_speed||0) + (v2?.tx_speed||0);
  const parts = [];
  if(rxT>0||txT>0) parts.push(`↓${fmtBytesTotal(rxT)} ↑${fmtBytesTotal(txT)}`);
  parts.push(`⇅ ${fmtBytes(rxS+txS)}`);
  setT('hdr-traffic', parts.join('  '));
}

// ---- Render server card ----
function renderSrv(d, pfx){
  const online = d?.online;
  [el(`dot-${pfx}`), el(`hdot-${pfx}`)].forEach(e=>{ if(e) e.className='dot '+(online?'on':'off'); });
  const pillEl = el(`pill-${pfx}`);
  if(pillEl) pillEl.className='hdr-pill '+(online?'on':'off');
  const errEl = el(`err-${pfx}`);
  if(errEl){ if(!online&&d?.error){ errEl.style.display='block'; errEl.textContent=d.error; } else errEl.style.display='none'; }

  setT(`ip-${pfx}`, d?.ip||'');
  setT(`host-${pfx}`, d?.host||'');
  setT(`hname-${pfx}`, `${pfx.toUpperCase()} ${d?.ip||''}`);

  if(!online){
    setH(`gauges-${pfx}`, '');
    setH(`details-${pfx}`, '');
    return;
  }

  // ---- 4 Ring gauges: CPU, RAM, Avail, Disk ----
  const cpuPct = Math.min(100, (d.load1||0) / (d.cpus||1) * 100);
  const ramPct = d.mem_total_mb>0 ? Math.round(d.mem_used_mb/d.mem_total_mb*100) : 0;
  const availPct = d.mem_total_mb>0 ? Math.round((d.mem_avail_mb||0)/d.mem_total_mb*100) : 0;
  const dPct = d.disk_pct||0;

  const cpuMhz = d.cpu_mhz>0 ? `${(d.cpu_mhz/1000).toFixed(1)}GHz` : '';
  const cpuSub = `${d.cpus||1}×${cpuMhz||'CPU'}`;

  let gaugesHtml =
    ringSvg(`cpu-${pfx}`, cpuPct, ringColor(d.load1), `${Math.round(cpuPct)}%`,
      'CPU', `${cpuSub}<br>${fmtUptime(d.uptime_s)}`) +
    ringSvg(`ram-${pfx}`, ramPct, gaugeColor(ramPct), `${ramPct}%`,
      'RAM', `${fmtMB(d.mem_used_mb)}/${fmtMB(d.mem_total_mb)}`) +
    ringSvg(`avail-${pfx}`, 100-availPct, gaugeColor(100-availPct), `${availPct}%`,
      'Available', `${fmtMB(d.mem_avail_mb)} free`) +
    ringSvg(`disk-${pfx}`, dPct, gaugeColor(dPct), `${dPct}%`,
      'Disk', `${d.disk_used||'?'}/${d.disk_total||'?'}`);
  setH(`gauges-${pfx}`, gaugesHtml);

  // ---- Details grid ----
  const bc = (d.mem_buffers_mb||0) + (d.mem_cached_mb||0);
  const detailPairs = [
    ['Load avg', `${d.load1??'—'} / ${d.load5??'—'} / ${d.load15??'—'}`],
    ['Swap', fmtSwap(d.swap)],
    ['Buf+Cache', bc>0 ? fmtMB(bc) : '—'],
    ['Inodes', d.disk_inodes||'—'],
    ['TCP / UDP', `${d.tcp_est??0} / ${d.udp_conn??0}`],
    ['Processes', d.proc_count??'—'],
    ['Open files', d.open_files ? fmtNum(d.open_files) : '—'],
    ['Free RAM', d.mem_free_mb!=null ? fmtMB(d.mem_free_mb) : '—'],
  ];
  let detHtml = '';
  for(const [k,v] of detailPairs){
    detHtml += `<div class="detail-item"><span class="detail-key">${k}</span><span class="detail-val">${escH(String(v))}</span></div>`;
  }
  setH(`details-${pfx}`, detHtml);

  // ---- Network ----
  setT(`if-${pfx}`, d.net_if||'');
  setT(`rx-${pfx}`, fmtBytes(d.rx_speed));
  setT(`tx-${pfx}`, fmtBytes(d.tx_speed));
  setT(`rxtotal-${pfx}`, fmtBytesTotal(d.rx_total));
  setT(`txtotal-${pfx}`, fmtBytesTotal(d.tx_total));

  const rxH = hist[`${pfx}_rx`], txH = hist[`${pfx}_tx`];
  setH(`spark-${pfx}`, spark(rxH, 'var(--green)', 'var(--blue)', txH));

  // Top connections
  const tc = d.top_conn && d.top_conn !== 'none' ? d.top_conn : '—';
  setT(`topconn-${pfx}`, tc);

  renderChips(d, pfx);
}

function chip(cls, label, dot=true){
  const d = dot ? '<span class="chip-dot"></span>' : '';
  return `<span class="chip ${cls}">${d}${escH(label)}</span>`;
}
const SEP = '<span class="chip-sep"></span>';

function renderChips(d, pfx){
  const hs = fmtAge(d.hs0_age);
  let html = '';
  if(pfx==='v1'){
    html =
      chip(stCls(d.awg0), `awg0 ${d.awg0||'—'}`) +
      chip(stCls(d.awg1), `awg1 ${d.awg1||'—'}`) + SEP +
      chip(hs.c, `HS ${hs.t}`, false) +
      chip('d', `P ${d.peers_awg0??0}/${d.peers_awg1??0}`, false) +
      chip('d', `TCP ${d.tcp_est??0}`, false) + SEP +
      chip(stCls(d.tun_ping), `tunnel ${d.tun_ping||'—'}`);
  } else {
    html =
      chip(stCls(d.awg0), `awg0 ${d.awg0||'—'}`) + SEP +
      chip(hs.c, `HS ${hs.t}`, false) +
      chip('d', `P ${d.peers_awg0??0}`, false) +
      chip('d', `TCP ${d.tcp_est??0}`, false) + SEP +
      chip(stCls(d.agh), 'AdGuard') +
      chip(stCls(d.dns53), 'DNS:53') +
      chip(stCls(d.web3000), 'Web:3000') +
      chip(stCls(d.wan_ping), `WAN ${d.wan_ping||'—'}`);
  }
  setH(`chips-${pfx}`, html);
}

// ---- Log ----
const LOG_FILTER = {DEBUG:true, INFO:true, WARN:true, ERROR:true};
let logAutoScroll = true;
let logLines = [];

document.querySelectorAll('.log-filter-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const lvl = btn.dataset.lvl;
    LOG_FILTER[lvl] = !LOG_FILTER[lvl];
    btn.classList.toggle('active', LOG_FILTER[lvl]);
    renderLog();
  });
});
el('log-autoscroll').addEventListener('click', ()=>{
  logAutoScroll = !logAutoScroll;
  el('log-autoscroll').classList.toggle('on', logAutoScroll);
});

const logBody = el('log-body');
logBody.addEventListener('scroll', ()=>{
  const atBottom = logBody.scrollHeight - logBody.scrollTop - logBody.clientHeight < 30;
  if(!atBottom && logAutoScroll){
    logAutoScroll = false;
    el('log-autoscroll').classList.remove('on');
  }
});

function parseLine(raw){
  const m = raw.match(/^\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]\s+\[(\w+)\]\s+(.*)$/);
  if(m) return {ts:m[1].slice(11), lvl:m[2], msg:m[3]};
  return {ts:'', lvl:'DEBUG', msg:raw};
}

function renderLog(){
  const frag = document.createDocumentFragment();
  let count = 0;
  for(const raw of logLines){
    const p = parseLine(raw);
    if(!LOG_FILTER[p.lvl]) continue;
    count++;
    const div = document.createElement('div');
    div.className = `log-line ${p.lvl}`;
    div.innerHTML =
      `<span class="log-ts">${p.ts}</span>`+
      `<span class="log-lvl ${p.lvl}">${p.lvl.slice(0,3)}</span>`+
      `<span class="log-msg">${escH(p.msg)}</span>`;
    frag.appendChild(div);
  }
  logBody.innerHTML='';
  logBody.appendChild(frag);
  if(logAutoScroll) logBody.scrollTop = logBody.scrollHeight;
  setT('log-count', String(count));
}

// ---- Connections ----
function renderConns(v1, v2){
  const totalTcp = (v1?.tcp_est||0) + (v2?.tcp_est||0);
  const totalUdp = (v1?.udp_conn||0) + (v2?.udp_conn||0);
  setT('conn-badge', String(totalTcp + totalUdp));

  let html = '';
  for(const [label, d] of [['VPS1',v1],['VPS2',v2]]){
    const conns = d?.conns || [];
    const tcp = d?.tcp_est ?? 0;
    const udp = d?.udp_conn ?? 0;
    const rxS = fmtBytes(d?.rx_speed||0);
    const txS = fmtBytes(d?.tx_speed||0);
    html += `<div class="conn-section">`;
    html += `<div class="conn-section-hdr">
      <span>${label}</span>
      <span class="conn-count">TCP ${tcp}</span>
      <span class="conn-count">UDP ${udp}</span>
      <span style="margin-left:auto;font-size:10px;color:var(--dim);font-family:monospace;text-transform:none;font-weight:400">
        <span style="color:var(--green)">↓${rxS}</span>
        <span style="color:var(--blue)">↑${txS}</span>
      </span>
    </div>`;
    if(conns.length===0){
      html += '<div class="conn-none">no connections</div>';
    } else {
      for(const c of conns){
        const proto = (c.proto || 'tcp').toUpperCase();
        html += `<div class="conn-row">
          <span class="conn-local">[${escH(proto)}] ${escH(c.local||'')}</span>
          <span class="conn-arrow">→</span>
          <span class="conn-remote">${escH(c.remote||'')}</span>
        </div>`;
      }
    }
    html += '</div>';
  }
  setH('conn-body', html);
}

// ---- Main poll ----
let nextAt = 0;

function mergeVps(prev, cur) {
  if (!prev || !cur) return cur;
  const merged = Object.assign({}, cur);
  const keep = ['rx_total','tx_total','mem_total_mb','mem_used_mb','mem_avail_mb',
    'mem_free_mb','mem_buffers_mb','mem_cached_mb','disk_pct','disk_used','disk_total',
    'tcp_est','udp_conn','proc_count','open_files','cpus','cpu_mhz','uptime_s'];
  for (const k of keep) {
    if ((!merged[k] && merged[k] !== 0) && prev[k]) merged[k] = prev[k];
  }
  return merged;
}

async function poll(){
  nextAt = Date.now() + POLL_MS;
  let data = null;
  try {
    const r = await fetch(DATA_URL+'?_='+Date.now());
    if(r.ok) data = await r.json();
  } catch(_){}

  if(data && data.ts){
    if (lastData) {
      if (data.vps1) data.vps1 = mergeVps(lastData.vps1, data.vps1);
      if (data.vps2) data.vps2 = mergeVps(lastData.vps2, data.vps2);
    }
    lastData = data;
    renderHdrVpnCount(data);
    renderHdrTraffic(data);
    pushHist('v1_rx', data.vps1?.rx_speed||0);
    pushHist('v1_tx', data.vps1?.tx_speed||0);
    pushHist('v2_rx', data.vps2?.rx_speed||0);
    pushHist('v2_tx', data.vps2?.tx_speed||0);
    saveHist();

    renderSrv(data.vps1, 'v1');
    renderSrv(data.vps2, 'v2');
    renderConns(data.vps1, data.vps2);

    if(Array.isArray(data.log) && data.log.length){
      logLines = data.log;
      renderLog();
    }

    const ts = new Date(data.ts*1000);
    setT('hdr-ts', ts.toLocaleTimeString());

    if(typeof _postPollHooks !== 'undefined'){
      for(const h of _postPollHooks) h(data);
    }
  }
  setTimeout(poll, POLL_MS);
}

function tickCd(){
  const rem = Math.max(0, nextAt - Date.now());
  const pct = rem / POLL_MS * 100;
  const fill = el('cd-fill');
  if(fill) fill.style.width = pct.toFixed(1)+'%';
  setT('cd-num', Math.ceil(rem/1000)+'s');
  requestAnimationFrame(tickCd);
}

poll();
tickCd();

// ---- Activity Log ----
const ACT_MAX = 200;
let actEvents = [];
const actBody = el('activity-body');

el('act-clear').addEventListener('click', () => {
  actEvents = [];
  renderActivity();
});

function pushAct(type, tag, msg) {
  actEvents.push({ ts: new Date().toLocaleTimeString(), type, tag, msg });
  if (actEvents.length > ACT_MAX) actEvents.shift();
}

const FILTER_RE = /filter|block|allow|deny|adguard|agh|dns|query|domain|rule/i;
const CONN_RE   = /connect|tunnel|peer|handshake|vpn|awg|wg/i;
let seenLogLines = new Set();

function processLogLines(lines) {
  for (const raw of lines) {
    if (seenLogLines.has(raw)) continue;
    seenLogLines.add(raw);
    if (seenLogLines.size > 2000) {
      const arr = [...seenLogLines];
      seenLogLines = new Set(arr.slice(arr.length - 1000));
    }
    const m = raw.match(/^\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]\s+\[(\w+)\]\s+(.*)$/);
    if (!m) { if (raw.trim() && !raw.startsWith('|awk')) pushAct('warn', 'RAW', raw.trim()); continue; }
    const [, , lvl, msg] = m;
    if (lvl === 'ERROR') pushAct('error', 'ERR', msg);
    else if (lvl === 'WARN') { if (!/Permanently added/.test(msg)) pushAct('warn', 'WRN', msg); }
    else if (FILTER_RE.test(msg)) pushAct('filter', 'FILTER', msg);
    else if (CONN_RE.test(msg)) pushAct('conn', 'CONN', msg);
  }
}

function renderActivity() {
  setT('act-badge', String(actEvents.length));
  if (actEvents.length === 0) {
    actBody.innerHTML = '<div class="act-none">нет событий</div>';
    return;
  }
  const frag = document.createDocumentFragment();
  for (const ev of actEvents) {
    const div = document.createElement('div');
    div.className = `act-line ${ev.type}`;
    div.innerHTML =
      `<span class="act-ts">${ev.ts}</span>` +
      `<span class="act-tag ${ev.type}">${escH(ev.tag)}</span>` +
      `<span class="act-msg">${escH(ev.msg)}</span>`;
    frag.appendChild(div);
  }
  actBody.innerHTML = '';
  actBody.appendChild(frag);
  actBody.scrollTop = actBody.scrollHeight;
}

const _postPollHooks = [];
_postPollHooks.push((data) => {
  if (!data) return;
  if (Array.isArray(data.log)) processLogLines(data.log);
  renderActivity();
});

// ---- Ping modal ----
function getPingTargets() {
  return [
    { label: 'VPS1',    host: lastData?.vps1?.ip || '' },
    { label: 'VPS2',    host: lastData?.vps2?.ip || '' },
    { label: 'Tunnel',  host: '10.8.0.2' },
    { label: '8.8.8.8', host: '8.8.8.8' },
  ].filter(t => t.host);
}

function openPingModal() { el('ping-overlay').classList.add('open'); runPing(); }
function closePingModal() { el('ping-overlay').classList.remove('open'); }

el('ping-overlay').addEventListener('click', e => { if (e.target === el('ping-overlay')) closePingModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePingModal(); });

function renderPingWaiting() {
  let html = '';
  for (const t of getPingTargets()) {
    html += `<div class="ping-row"><span class="ping-label">${escH(t.label)}</span><span class="ping-host">${escH(t.host)}</span><span class="ping-badge wait">…</span></div>`;
  }
  setH('ping-rows', html);
}

function renderPingResults(results) {
  let html = '';
  for (const t of getPingTargets()) {
    const r = results?.[t.host];
    let badge;
    if (!r) badge = '<span class="ping-badge fail">—</span>';
    else if (r.status === 'ok') {
      const loss = r.loss > 0 ? ` <span style="color:var(--yellow);font-size:9px">${r.loss}% loss</span>` : '';
      badge = `<span class="ping-badge ok">${r.avg_ms} ms</span>${loss}`;
    } else badge = `<span class="ping-badge fail">${r.status==='timeout'?'timeout':'fail'}</span>`;
    html += `<div class="ping-row"><span class="ping-label">${escH(t.label)}</span><span class="ping-host">${escH(t.host)}</span>${badge}</div>`;
  }
  setH('ping-rows', html);
}

async function runPing() {
  const btn = el('ping-btn'), rerun = el('ping-rerun');
  btn.classList.add('running');
  if (rerun) rerun.disabled = true;
  setT('ping-status-msg', 'Опрашиваем…');
  renderPingWaiting();
  const targets = getPingTargets();
  if (!targets.length) { renderPingResults(null); setT('ping-status-msg', 'Нет данных'); btn.classList.remove('running'); if(rerun) rerun.disabled=false; return; }
  const hosts = targets.map(t => t.host).join(',');
  try {
    const r = await fetch(`/api/ping?hosts=${encodeURIComponent(hosts)}`);
    if (r.ok) { renderPingResults(await r.json()); setT('ping-status-msg', 'Готово'); }
    else { renderPingResults(null); setT('ping-status-msg', `Ошибка: HTTP ${r.status}`); }
  } catch (e) { renderPingResults(null); setT('ping-status-msg', `Ошибка: ${e.message}`); }
  btn.classList.remove('running');
  if (rerun) rerun.disabled = false;
}
</script>
</body>
</html>
